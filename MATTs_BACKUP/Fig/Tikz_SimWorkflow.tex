\documentclass[10pt,a4paper]{book}

\usepackage[left=2.5cm, right=2cm, top=2cm, bottom=2cm]{geometry}
\usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}

\usepackage{graphicx}
\usepackage{color}
\usepackage{tikz}
	\usetikzlibrary{shapes,arrows}
\usepackage{dirtree}

\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{listings}
\usepackage{blindtext}

\usepackage{color}

\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}

\lstset{ %
  backgroundcolor=\color{white},   % choose the background color; you must add \usepackage{color} or \usepackage{xcolor}
  %basicstyle=\footnotesize,        % the size of the fonts that are used for the code
  basicstyle=\ttfamily,%\footnotesize,
  breakatwhitespace=false,         % sets if automatic breaks should only happen at whitespace
  breaklines=true,                 % sets automatic line breaking
  captionpos=b,                    % sets the caption-position to bottom
  columns=fixed,
  commentstyle=\color{mygreen},    % comment style
  deletekeywords={...},            % if you want to delete keywords from the given language
  escapeinside={\%*}{*)},          % if you want to add LaTeX within your code
  extendedchars=true,              % lets you use non-ASCII characters; for 8-bits encodings only, does not work with UTF-8
  %frame=single,                    % adds a frame around the code
  keepspaces=true,                 % keeps spaces in text, useful for keeping indentation of code (possibly needs columns=flexible)
  keywordstyle=\color{blue},       % keyword style
  language=Matlab,                 % the language of the code
  morekeywords={*,...},            % if you want to add more keywords to the set
  %numbers=left,                    % where to put the line-numbers; possible values are (none, left, right)
  numbers=none,
  %numbersep=5pt,                   % how far the line-numbers are from the code
  numberstyle=\tiny\color{mygray}, % the style that is used for the line-numbers
  rulecolor=\color{black},         % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. comments (green here))
  showspaces=false,                % show spaces everywhere adding particular underscores; it overrides 'showstringspaces'
  showstringspaces=false,          % underline spaces within strings only
  showtabs=false,                  % show tabs within strings adding particular underscores
  %stepnumber=2,                    % the step between two line-numbers. If it's 1, each line will be numbered
  stringstyle=\color{mymauve},     % string literal style
  tabsize=3,                       % sets default tabsize to 2 spaces
  title=\lstname                   % show the filename of files included with \lstinputlisting; also try caption instead of title
}


\begin{document}
\tikzstyle{decision} = [diamond, draw, fill={blue!25!black}, text=white,
    text width=2cm, text badly centered, node distance=3cm, inner sep=0pt]
\tikzstyle{block} = [rectangle, draw, fill=blue, text=white,
    minimum width=4cm, height=2cm]
\tikzstyle{box} = [rectangle, draw, text=black,
    width=12cm, height=18cm, node distance=8cm]
\tikzstyle{line} = [draw, -latex']
\tikzstyle{cloud} = [draw, ellipse,fill=red!20, node distance=3cm,
    minimum height=2cm]


\begin{figure}
	\centering
	\begin{tikzpicture}
		\node [box] (gui) {
		\begin{tikzpicture}[node distance = 1.5cm, auto]
    	\node [block] (guiSimulate) {function gui\_simulate};
    	\node [block, below of=guiSimulate] (simProcedure) {function simProcedure()};
			\node [block, below of=simProcedure] (writeQdot) {writeQdot()};
			\end{tikzpicture}
		};
		\node [box, below of=gui] (boxsimAll) {
			simAll                                                              \hfill \newline \\
		\begin{tikzpicture}[node distance = 1.5cm, auto]
			\node [block] (sweep) {function sweep};
			\node [block, below of=sweep] (writeCmd) {write Cmd file};
			\node [block, below of=writeCmd] (OMEN) {OMEN};
			\node [block, below of=OMEN] (logfile) {log file};
			\node [block, below of=logfile] (globallog) {global log file};
			\node [cloud, right of=OMEN] (counter) {for length of QDOA};
	    \path [line] (sweep) -- node[midway,right] {QDOA} (writeCmd);
	    \path [line] (writeCmd) -- (OMEN);
	    \path [line] (OMEN) -- (logfile);
	    \path [line] (logfile) -- (globallog);
	    \path [line] (logfile) -| (counter);
	    \path [line] (counter) |- (writeCmd);
		\end{tikzpicture}
		};
		\node [cloud, right of=gui] (setcounter) {for \# Simulation sets};
		\path [line] (boxsimAll) -- (setcounter);
		\path [line] (setcounter) |- (gui);
		\path [line] (gui) -- node[midway,right] {QDOG} (boxsimAll);
	\end{tikzpicture}
	\caption{Function calls during simulation procedure}
\end{figure}

\end{document}